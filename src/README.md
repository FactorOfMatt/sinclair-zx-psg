# README.md for src/ directory

## What's in this directory?

- `build`:  This directory contains the artifacts generated during the build-process.  These files are temporary and indeed aren't saved along with the repo.
- `common`:  Source code common to all supported sound-cards.  Source exists in .txt form (for conversion into ZX-Spectrum BASIC), .c form (for the bartab tool) and in .src form (the z80 assembler code).
- `releases`:  This directory contains the final .tap and .zip files generated by the build process.  Only the .zip files are saved with the repo.

## The MINUETZ program

The **MOZART-LIVES** article in the March 1983 edition of Your Computer consists the AY-3-8910 ZX compatible sound board and the MINUETZ program.  Before the main BASIC listing of the MINUETZ program is the heading:

**`"MINUETZ"`**  

**`R.K. HOPKINS & H.J.LAVERTY 1983`**  

Minuetz is what the authors called it and so shall we.

I distinctly remember being mesmerized by how good the graphics looked for the stave and notes on the cover and in the article.  Pure magic.  Those images have stuck with me for over 40 years.
  
  
## Running the Code
If you have no interest in building the software for yourself you can just use one of the pre-built packages in the `releases/` directory:
- `minuetz-he.zip`: The package built for the Hobby Electronics Sinclair Sound Board.
- `minuetz-yc.zip`: The package built for the Your Computer Mozart Lives Sound Board.
- `minuetz-wss.zip`: The package built for the William Stuart Systems Sound Card.  This particular build has not yet been tested on real hardware.
- `minuetz-zon.zip`: The package built for the Bi-Pak ZON-X (possibly X-81) Sound Card.  This particular build has not yet been tested on real hardware.

Each .zip file contains three .tap files:
- `ay-reg-test.tap`: A simple Spectrum program to verify that the I/O ports are capable of selecting a register, writing to it and reading it back.  This test should help verify that RA, RV and RR are set correctly when supporting new sound-cards.
- `ay-test.tap`: The small Spectrum test program from the Mozart-Lives article.  I left the REMs in because it's 2025 and I didn't need to use a real Speccy.
- `minuetz.tap`: The main minuetz (short for Minuet-ZX possibly?) program.  The .tap has two parts: the main basic program and the machine-code/data-tables part.  The BASIC loads the second-part when it starts.

## Third-party tools
The build environment takes advantage of some modern tools and was created on a standard Linux system.  Converting this build environment for other operating systems should not pose too much of a problem.  For windows, cygwin etc should suffice.

- **`bin2tap`**  This small program, written by Michal Jurica, converts a binary file into a .tap format file that can then be used to play back audio for loading by a Spectrum.  The github for this cool program is: https://github.com/compilersoftware/bin2tap 

- **`zmakebas`**  This program, written by Russell Marks, takes a regular text-file, tokenizes it as a ZX-Spectrum would then emits the equivalent binary.  This github for this magic is: https://github.com/z00m128/zmakebas

- **`spasm`**  This is my own **sp**ecial **as**se**m**bler.  The syntax and general 'feel' of this assembler closely resemble the **dasm** assembler by Matt Dillon from way back in the 80s.  My assembler however has been written from scratch, takes up way more memory and is almost certainly slower.  It does, however. support the 6502, 65c02, 65c816 and the z80.  As of writing, I haven't released **spasm** in any form and as such may be difficult to find.
  - Converting the minuetz-assembly.src to work with your favourite z80-assembler should not be a difficult task at all.  The biggest hurdle is likely to be the 'check_addr' macro (`mac check_addr`) and its invocations right at the end of the `minuetz-assembly.src` file.  Worry not!  The macro and invocations can safely be commented out - they just exists to ensure the entry points are consistent with what is expected by the BASIC program.
  - Hopefully I will soon be able to release at least a binary form of the **spasm** executable in the near future.

- **`gcc`**  This is the standard gnu C compiler.  Any ANSI C compiler should work just fine.  The program that we compile runs in the host operating-system and simply generates a source-file.  Nothing extravagant is required at all.

## How the build works
- `src/Makefile` controls the build and the ultimate goal is to build `.zip` files for each of the (currently 4) supported AY cards.
  - each variant (yc, he, zon and wss) uses the same source (located in `src/common/`) and differ only in the definitions of the `RA`, `RV`, `RR` and `ROOT` environments passed to the sub-make in `src/common/`.
  - Support for additional sound cards may be added by copying an existing target and modifying the `RA`, `RV`, `RR` and `ROOT` variables as necessary.  You will also need to add your new target to the `all:` rule.
    - The `RA` variable designates the I/O port address that is written to in order to select the PSG register.
    - The `RV` variable designates the I/O port address that is written to in order to write to the selected register (`RA`).
    - The `RR` variable designates the I/O port address that is read from in order to read the selected register (`RA`).  - `make` will rebuild everything that is out-of-date.
  - `make clean` removes build-artifacts from the `src/` directory.  It leaves the `.zip` files in the `src/releases/` directory intact.
  - `make very-clean` removes all build-artifacts including the `.zip` files in `src/releases/`.
- `src/common/Makefile` controls the build of a given supported AY card variant.  The parameters to the build are passed in through the `RA`, `RV`,` RR` and `ROOT` environment variables.
- All source files reside inside `src/common`.  Several of the source-files are preprocessed (using `sed`) in order to customise them for the AY card in question.  These customisations are placed in the `build/` directory.  The source files are:
  - `ay-reg-test-basic.txt`  This small BASIC program simply verifies that the IO port addresses can be written and read as expected.  This file gets customised then run through `zmakebas` to generate `ay-reg-test.tap`.
  - `ay-test-basic.txt`  This small BASIC program was listed in the Your Computer article and simply attempts to make a sound using the AY card.  This file gets customised then run through `zmakebas` to generate `ay-test.tap`.
  - `bartab.c`  This C program generates the assembler source code for the note-data from the Your Computer article.  The 18 notes for each of the 138 bars are stored in this program as strings. The main part of the program validates them and outputs them as assembler source for inclusion in the main assembly file.
  - `minuetz-assembly.src`  This Z80 assembly source was listed in the Your Computer article.  We use this source to generate all the binary data for the minuetz program.  In the article a poker-program was used.  This is easier.  The comments in the source are mine.  They might not be 100% correct but won't be far off.
  - `minuetz-basic.txt`  This large BASIC program was listed in the Your Computer article and is the main part of the minuetz program.  This file gets customized them run through `zmakebas` to generate `minuetz.tap`  The `zmakebas` program allows comments to be included in the text file that won't be part of the final BASIC output.  I've used this feature and added a fair number of comments to the code to help me understand how it works (and possibly ways in which it doesn't)
  
